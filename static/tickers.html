<html>
	<head>
		<!-- <meta http-equiv="refresh" content="1" /> -->
		<link rel="icon" href="data:,">
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
		<script>
			function doFilter() {
				window.location.href = '/{{ticker}}?from_time=' + $("#from_time").val() + '&to_time=' + $("#to_time").val();
			}
		</script>
		<script>
			let ticker = '{{ticker}}';
			let labels = {{data[ticker]['labels']|safe}};
			let bids = {{data[ticker]['bids']}};
			let asks = {{data[ticker]['asks']}};
			let lasts = {{data[ticker]['lasts']}};

			let data = {
				labels: labels,
				datasets: [
					{
						label: 'bid',
						data: bids,
						borderWidth: 1,
						yAxisID: 'y1',
						borderColor: "green",
					},
					{
						label: 'ask',
						data: asks,
						borderWidth: 1,
						yAxisID: 'y1',
						borderColor: "red",
					},
					{
						label: 'last',
						data: lasts,
						borderWidth: 1,
						yAxisID: 'y1',
						borderColor: "#FFC300",
					},
				],
			};

			let options = {
				responsive: true,
				stacked: true,
				//maintainAspectRatio: false,
    			animation: {
        			duration: 0
    			},
				plugins: {
					title: {
						display: true,
						text: '{{ticker}}'
					}
				},
				scales: {
					y: {
						type: 'linear',
						position: 'left',
						// min: 33,
						// max: 35,
						display: false,
						grid: {
							drawOnChartArea: false
						}
					},
					y1: {
						type: 'linear',
						position: 'right',
					},
				},
				plugins: {
					zoom: {
						pan: {
							enabled: false,
							mode: 'xy',
						},
						zoom: {
							wheel: {
								enabled: true,
							},
							pinch: {
								enabled: true
							},
							drag: {
								enabled: true
							},
							mode: 'xy',
						},
					}
				},
			};

			let config = {
				type: 'line',
				data: data,
				options: options,
			};
		</script>
	</head>

	<div class="chart-wrapper">
		<h2>{{ticker}} |
			<input type="text" id="from_time" value="" size="3" />
			<input type="text" id="to_time" value="" size="3" />
			<button type="button" id="range_button" onclick="doFilter()">Select</button>
			<a href="{{key}}?bm=-1">Today</a> |
			<a href="{{key}}?bm=0">Open</a> |
			<a href="{{key}}?bm=60">60 minutes</a> |
			<a href="{{key}}?bm=45">45 minutes</a> |
			<a href="{{key}}?bm=30">30 minutes</a> |
			<a href="{{key}}?bm=15">15 minutes</a> |
			<a href="{{key}}?bm=10">10 minutes</a> |
			<a href="{{key}}?bm=5">5 minutes</a> |
			<a href="{{key}}?bm=1">2 minutes</a> |
			<a href="{{key}}?bm=1">1 minute</a>
		</h2>
		<canvas id="{{ticker}}"></canvas>
	</div>

	<script>
		const ctx = document.getElementById('{{ticker}}');
		let stockChart = new Chart(ctx, config);

		const getNewTickerData = async (url) => {
			const response = await fetch(url, {
			"headers": {
				"accept": "*/*",
				"content-type": "application/json",
			},
			"method": "GET"
			});
			return await response.json();
		}

		const updateChart = async () => {
			lastTime = labels[labels.length - 1].split(':');
			lastTime[0] = parseInt(lastTime[0]) - 4;  // ET
			lastTime[2] = parseInt(lastTime[2]) + 1;  // want 1 second more
			url = ticker + '?from_time=' + lastTime.join(':');
			newData = await getNewTickerData(url);

			// labels = labels.concat(newData[ticker].labels)
			// bids = bids.concat(newData[ticker].bids);
			// asks = asks.concat(newData[ticker].asks);
			// lasts = lasts.concat(newData[ticker].lasts);
			data.labels = data.labels.concat(newData[ticker].labels)
			data.datasets[0].data = data.datasets[0].data.concat(newData[ticker].bids);
			data.datasets[1].data = data.datasets[1].data.concat(newData[ticker].asks);
			data.datasets[2].data = data.datasets[2].data.concat(newData[ticker].lasts);
			config.data = data;
			stockChart.destroy();
			stockChart = new Chart(ctx, config);
		}

	</script>
</html>