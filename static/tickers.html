<html>
	<head>
		<!-- <meta http-equiv="refresh" content="1" /> -->
		<link rel="icon" href="data:,">
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
		<script>
			function doFilter() {
				window.location.href = '/{{ticker}}?from_time=' + $("#from_time").val() + '&to_time=' + $("#to_time").val();
			}
		</script>
		<script>
			const ticker = '{{ticker}}';
			let dataObj = {
				times: {{data[ticker]['times']|safe}},
				bids: {{data[ticker]['bids']}},
				asks: {{data[ticker]['asks']}},
				lasts: {{data[ticker]['lasts']}},
			}

			function getChartData() {
				return {
					labels: dataObj.times,
					datasets: [
						{
							label: 'bid',
							data: dataObj.bids,
							borderWidth: 1,
							yAxisID: 'y1',
							borderColor: "green",
						},
						{
							label: 'ask',
							data: dataObj.asks,
							borderWidth: 1,
							yAxisID: 'y1',
							borderColor: "red",
						},
						{
							label: 'last',
							data: dataObj.lasts,
							borderWidth: 1,
							yAxisID: 'y1',
							borderColor: "#FFC300",
						},
					],
				};
			}

			let chartOptions = {
				responsive: true,
				stacked: true,
				//maintainAspectRatio: false,
    			animation: {
        			duration: 0
    			},
				plugins: {
					title: {
						display: true,
						text: ticker
					}
				},
				scales: {
					y: {
						type: 'linear',
						position: 'left',
						// min: 33,
						// max: 35,
						display: false,
						grid: {
							drawOnChartArea: false
						}
					},
					y1: {
						type: 'linear',
						position: 'right',
					},
				},
				plugins: {
					zoom: {
						pan: {
							enabled: false,
							mode: 'xy',
						},
						zoom: {
							wheel: {
								enabled: true,
							},
							pinch: {
								enabled: true
							},
							drag: {
								enabled: true
							},
							mode: 'xy',
						},
					}
				},
			};

			function getChartConfig() {
				return {
					type: 'line',
					data: getChartData(),
					options: chartOptions,
				};
			}
		</script>
	</head>

	<div class="chart-wrapper">
		<h2>{{ticker}} |
			<input type="text" id="from_time" value="" size="3" />
			<input type="text" id="to_time" value="" size="3" />
			<button type="button" id="range_button" onclick="doFilter()">Select</button>
			<a href="{{key}}?bm=-1">Today</a> |
			<a href="{{key}}?bm=0">Open</a> |
			<a href="{{key}}?bm=60">60 minutes</a> |
			<a href="{{key}}?bm=45">45 minutes</a> |
			<a href="{{key}}?bm=30">30 minutes</a> |
			<a href="{{key}}?bm=15">15 minutes</a> |
			<a href="{{key}}?bm=10">10 minutes</a> |
			<a href="{{key}}?bm=5">5 minutes</a> |
			<a href="{{key}}?bm=1">2 minutes</a> |
			<a href="{{key}}?bm=1">1 minute</a>
		</h2>
		<canvas id="{{ticker}}"></canvas>
	</div>

	<script>
		const ctx = document.getElementById('{{ticker}}');
		let stockChart = new Chart(ctx, getChartConfig());

		const getNewTickerData = async (url) => {
			const response = await fetch(url, {
			"headers": {
				"accept": "*/*",
				"content-type": "application/json",
			},
			"method": "GET"
			});
			return await response.json();
		}

		const updateChartWithNewData = async () => {
			begin = dataObj.times[dataObj.times.length - 1].split(':');
			begin[0] = parseInt(begin[0]);  // ET
			begin[2] = parseInt(begin[2]) + 1;  // want 1 second more

			//end = begin.concat([]);
			//end[0] += 1;
			
			url = ticker + '?from_time=' + begin.join(':');
			newData = await getNewTickerData(url);

			if (newData[ticker].times.length > 0) {
				dataObj.times = dataObj.times.concat(newData[ticker].times)
				dataObj.bids = dataObj.bids.concat(newData[ticker].bids);
				dataObj.asks = dataObj.asks.concat(newData[ticker].asks);
				dataObj.lasts = dataObj.lasts.concat(newData[ticker].lasts);

				stockChart.destroy();
				stockChart = new Chart(ctx, getChartConfig());
			}
		}

		let I = 1;
		function runUpdateInterval() {
			setTimeout(runUpdateInterval, I*1000);
			updateChartWithNewData();
		}

		runUpdateInterval();
	</script>
</html>