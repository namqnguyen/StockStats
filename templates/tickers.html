<html background>
	<head>
		<!-- <meta http-equiv="refresh" content="1" /> -->
		<link rel="icon" href="data:,">
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
		<script>
			function doFilter() {
				window.location.href = '/{{ticker}}?date=' + $("#date").val() + '&from_time=' + $("#from_time").val() + '&to_time=' + $("#to_time").val();
			}

		</script>
		<style>
			.customChartLegendCSSClass {
				/* display: inline-block;
				background-color: aqua; */
				font-family: Arial, Helvetica, sans-serif;
				font-size: 20;
				float: right;
				padding-right: 50px;
				/* border: 1px solid green; */
			}
		</style>
	</head>

	<body style="background-color:black;">
		<div class="chart-wrapper">
			<h2 id="timesheader" style="background-color: white;">
				<span id="ticker">{{ticker}}</span>
				<input type="text" id="date" value="{{date if date}}" size="7" />
				<input type="text" id="from_time" value="{{from_time if from_time}}" size="3" />
				<input type="text" id="to_time" value="{{to_time if to_time}}" size="3" />
				<button type="button" id="range_button" onclick="doFilter()">Select</button>
				| <input type="text" id="skipInterval" value="" size="2" /> <button id="resetInterval">res</button>
				<span id="timesContainer"></span>
				| <span id="low" style="color:red">Low: {{data[ticker]['low']}}</span>
				| <span id="high" style="color: green">High: {{data[ticker]['high']}}</span>
				| <button id="streamSwitch">Stream OFF</button>
			</h2>

			<!-- Price Chart -->
			<div id="PriceChartLegend" class="customChartLegendCSSClass"></div>
			<canvas id="{{ticker}}"></canvas>

			<!-- RSI Chart -->
			<div width="100%" style="columns:2;">
				<div id="volume-controls" style="font-family: Arial, Helvetica, sans-serif; color:#FFFFFF">
					<input id="volume-Y-axis-checkbox" type="checkbox">Vol. Y-axis?</input>
				</div>
				<div id="RSIchartLegend" class="customChartLegendCSSClass"></div>
			</div>
			<canvas id="RSIchart"></canvas>
		</div>

		<!-- <iframe id="refresher" src="http://127.0.0.1:5000/assets/refresher_frame.html"></iframe> -->
	</body>

	<script>
		const ticker = '{{ticker}}';
		let DATAINTERVAL = 1;

		let dataObj = {
			times: {{data[ticker]['times']|safe}},
			bids: {{data[ticker]['bids']}},
			asks: {{data[ticker]['asks']}},
			lasts: {{data[ticker]['lasts']}},
			volumes: {{data[ticker]['volumes']}},
			hidden: ['times'],
		};

		const exists = (what) => {
			try {
				let tmp = eval(what);
				return (typeof tmp !== 'undefined' && tmp !== null);
			} catch (e) {
				return false;
			}
		}
	</script>
	<script type="module">
		import {TickerNotification} from "/assets/js/alarm2.mjs";
		let allowed = ['bids', 'asks', 'lasts'];
		TickerNotification.askPermission((p)=>{
			if (p !== 'granted') {
				console.log('Permission is: ' + p);
				return;
			}
			window.tickerNotie = new TickerNotification(allowed, dataObj);
		});
	</script>
	<script src="/assets/js/common.js"></script>
	<script src="/assets/js/alarm.js"></script>
	<script src="/assets/js/chart_common.js"></script>
	<script src="/assets/js/price_chart.js"></script>
	<script src="/assets/js/rsi_chart.js"></script>
	<script>
		let timesArr = [-1, 0, 180, 120, 90, 60, 45, 30, 20, 15, 10, 5, 2, 1];
		timesArr.forEach(element => {
			let text = element + (element > 1 ? 'm' : 'm');
			if (element === 0) {
				text = 'Open';
			} else if (element === -1) {
				text = 'Today';
			}
			a = $('<a href="#">' + text + '</a>');
			a.click( e => {e.preventDefault(); showChartMinsBack(element); return false} );
			$('#timesContainer').append(' | ')
			$('#timesContainer').append(a);
		});


		$('#skipInterval').blur( (e) => { DATAINTERVAL = parseInt(e.target.value) } );
		$('#skipInterval').keypress( (e) => { if (e.which == 13) { DATAINTERVAL = parseInt(e.target.value) } } );
		$('#resetInterval').click( (e) => { $('#skipInterval').val(1); $('#skipInterval').blur(); } )
		$('#ticker').click( (e) => { stockChart.resetZoom(); } );
		$('#streamSwitch').click( (e) => {
			P ? $('#streamSwitch').html('Stream OFF') : $('#streamSwitch').html('Stream ON');
			P = !P;
		 });

		[30000, 20000, 10000].forEach( vol => {
			a = $('<a href="#" style="color:#FFFFFF">' + vol + '</a>');
			a.click( e => {
				e.preventDefault();
				rsiChart.options.scales.y_volume.max = vol;
				return false;
			});
			$('#volume-controls').append(' | ')
			$('#volume-controls').append(a);
		});

		$('#volume-Y-axis-checkbox').click( e => {
			rsiChart.options.scales.y_volume.display = !rsiChart.options.scales.y_volume.display;
		});

		let P = false;  // pause
		function runUpdateInterval() {
			if (!P) {
				updateChartsWithNewData();
			}
		}

		//runUpdateInterval();

		// let S = (seconds) => {
 		// 	createIframeRefresher('tickerRefresher', 'runUpdateInterval', seconds);
		// }

		// S(1);

		setInterval2(runUpdateInterval, 1000);

	</script>
</html>